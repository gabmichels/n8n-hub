{
    admin off

    # On-demand TLS for kiori.co subdomains and custom domains
    # Before issuing a cert, Caddy calls the "ask" endpoint to verify the domain
    # is mapped to a valid public workspace. Prevents cert abuse.
    on_demand_tls {
        ask {$KIORI_VERIFY_DOMAIN_URL:http://localhost:3000/api/internal/verify-domain}
        interval 5m
        burst 5
    }
}

# n8n automation platform
{$N8N_HOST:localhost} {
    reverse_proxy n8n-hub:5678
}

# PostHog analytics proxy (EU region)
# Bypasses ad blockers by routing through your domain
# Uses placeholder when not configured (won't match any real requests)
{$POSTHOG_PROXY_HOST:posthog-proxy.disabled.local} {
    # Handle CORS preflight requests
    @options method OPTIONS
    handle @options {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        header Access-Control-Max-Age "86400"
        respond "" 204
    }

    @static path /static/*
    handle @static {
        reverse_proxy https://eu-assets.i.posthog.com {
            header_up Host eu-assets.i.posthog.com
            header_down Access-Control-Allow-Origin "*"
        }
    }
    handle {
        reverse_proxy https://eu.i.posthog.com {
            header_up Host eu.i.posthog.com
            header_down Access-Control-Allow-Origin "*"
        }
    }

    handle_path /yt-proxy/* {
        reverse_proxy https://www.youtube.com {
            header_up Host www.youtube.com
            header_up -X-Forwarded-For
            header_up -X-Forwarded-Host
            header_up Cookie "SOCS=CAI"
        }
    }
}

# Fider feedback platform
# Uses placeholder when not configured (won't match any real requests)
{$FIDER_HOST:fider.disabled.local} {
    reverse_proxy fider:3000
}

# Kiori public workspace proxy
# Handles two types of domains:
#   1. Subdomains: {handle}.kiori.co (wildcard DNS → this server)
#   2. Custom domains: docs.example.com (CNAME → domains.kiori.co → this server)
#
# Both get auto-provisioned Let's Encrypt certs via on_demand_tls.
# Caddy calls the "ask" endpoint (configured above) before issuing any cert.
# All traffic is proxied to the Cloud Run API with the original Host in X-Custom-Domain.
{$KIORI_PROXY_MATCHER:*.kiori.disabled.local} {
    tls {
        on_demand
    }

    # Proxy API calls to Cloud Run API
    handle /api/* {
        reverse_proxy {$KIORI_API_URL:https://multiworkspace-rag-api-f75y5nmbmq-ez.a.run.app} {
            header_up Host {$KIORI_API_HOST:multiworkspace-rag-api-f75y5nmbmq-ez.a.run.app}
            header_up X-Custom-Domain {http.request.host}
            header_up X-Forwarded-Host {http.request.host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Proxy everything else to Firebase Hosting (serves the SPA)
    handle {
        reverse_proxy {$KIORI_WEB_URL:https://cw-rag-kiori-multiworkspace.web.app} {
            header_up Host {$KIORI_WEB_HOST:cw-rag-kiori-multiworkspace.web.app}
            header_up X-Custom-Domain {http.request.host}
            header_up X-Forwarded-Host {http.request.host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}
